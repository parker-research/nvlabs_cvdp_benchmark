FROM ghcr.io/hdl/sim/osvb

# https://github.com/RDSik/FPGA-Tools-Docker
# FROM ghcr.io/r0d0s/fpga_tools:latest

# Install dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        wget build-essential libssl-dev zlib1g-dev \
	    libncurses5-dev libncursesw5-dev libreadline-dev libsqlite3-dev \
		libgdbm-dev libdb5.3-dev libbz2-dev libexpat1-dev liblzma-dev tk-dev \
        git tree bash \
    && apt-get clean \
    && rm -rf /var/list/apt/lists/*


# Install `uv` for managing Python.
# https://docs.astral.sh/uv/guides/integration/docker/#installing-uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

WORKDIR /app

# Fix uv cache path.
RUN mkdir -p /.cache/uv && chmod -R 777 /.cache

RUN uv venv --python 3.12
RUN uv pip install openai loguru pyyaml

# Create /code directory and set permissions
RUN mkdir -p /code && chmod 777 /code

# Copy agent code
COPY agent.py /app/agent.py

RUN which iverilog

# Switch shell to bash. ChatGPT is better at writing valid `bash` than `sh`.
SHELL ["/bin/bash", "-c"]
ENV SHELL=/bin/bash

# Set the entrypoint.
WORKDIR /app
ENTRYPOINT ["uv", "run", "/app/agent.py"]
